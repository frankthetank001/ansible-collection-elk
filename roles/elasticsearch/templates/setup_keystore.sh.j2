#!/bin/bash

export ES_HOME={{ elasticsearch_extract_dir }}/elasticsearch
export ES_PATH_CONF={{ elasticsearch_conf_dir }}

KEYSTORE_FILE={{ elasticsearch_conf_dir }}/elasticsearch.keystore
CURRENT_HASH=$(sha256sum /tmp/elastic_password_file.txt | awk '{print $1}')

# If the keystore file doesn't exist, create it.
if [ ! -f $KEYSTORE_FILE ]; then
    {{ elasticsearch_extract_dir }}/elasticsearch/bin/elasticsearch-keystore create
else
    # If the keystore exists and the hash file matches the current hash, exit without doing anything.
    if [ -f /tmp/elastic_password_file.txt.hash ] && [[ "$CURRENT_HASH" == $(cat /tmp/elastic_password_file.txt.hash) ]]; then
        exit 0
    fi
fi

# Update the hash file with the current hash
echo "$CURRENT_HASH" > /tmp/elastic_password_file.txt.hash

KEYSTORE_PW=$(grep keystore_pw /tmp/elastic_password_file.txt | awk '{print $1}')
TRUSTORE_PW=$(grep truststore_pw /tmp/elastic_password_file.txt | awk '{print $1}')
HTTP_PW=$(grep http_pw /tmp/elastic_password_file.txt | awk '{print $1}')
BOOTSTRAP_PW=$(grep bootstrap_pw /tmp/elastic_password_file.txt | awk '{print $1}')

echo "$KEYSTORE_PW" | {{ elasticsearch_extract_dir }}/elasticsearch/bin/elasticsearch-keystore add -x -f xpack.security.transport.ssl.keystore.secure_password
echo "$TRUSTORE_PW" | {{ elasticsearch_extract_dir }}/elasticsearch/bin/elasticsearch-keystore add -x -f xpack.security.transport.ssl.truststore.secure_password
echo "$HTTP_PW" | {{ elasticsearch_extract_dir }}/elasticsearch/bin/elasticsearch-keystore add -x -f xpack.security.http.ssl.keystore.secure_password
echo "$BOOTSTRAP_PW" | {{ elasticsearch_extract_dir }}/elasticsearch/bin/elasticsearch-keystore add -x -f bootstrap.password

# exit with status 1 to indicate to ansible there was a change
exit 1
