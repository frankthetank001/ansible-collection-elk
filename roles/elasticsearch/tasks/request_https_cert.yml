---

- name: Install certbot (Debian-based systems)
  ansible.builtin.apt:
    name: certbot
    state: present
  when: ansible_os_family == 'Debian'
  become: true

- name: Install certbot (RedHat-based systems)
  ansible.builtin.yum:
    name: certbot
    state: present
  when: ansible_os_family == 'RedHat'
  become: true

- name: Check if certificate exists
  ansible.builtin.stat:
    path: "/etc/letsencrypt/live/{{ item }}/fullchain.pem"
  loop: "{{ elasticsearch_hosts }}"
  register: cert_exists

- name: Request HTTPS certificate if not present
  ansible.builtin.command:
    cmd: "certbot certonly --standalone -d {{ item.item }} --register-unsafely-without-email --agree-tos"
  loop: "{{ elasticsearch_hosts }}"
  when: not cert_exists.results[item.idx].stat.exists
  loop_control:
    label: "{{ item }}"
    index_var: idx
  become: true

- name: Create PKCS12 file for each elasticsearch host
  ansible.builtin.command:
    cmd: > 
      openssl pkcs12 -export 
      -in /etc/letsencrypt/live/{{ item }}/fullchain.pem
      -inkey /etc/letsencrypt/live/{{ item }}/privkey.pem
      -out /tmp/{{ item }}.p12
      -name elasticsearch -passout pass:{{ elasticsearch_cert_password }}
  loop: "{{ elasticsearch_hosts }}"
  become: true

- name: Copy the PKCS12 file to Elasticsearch certs directory
  ansible.builtin.copy:
    src: "/tmp/{{ item }}.p12"
    dest: "{{ elasticsearch_certs_dir }}/{{ item }}.p12"
    owner: "{{ elasticsearch_user }}"
    group: "{{ elasticsearch_group }}"
    mode: 0644
  loop: "{{ elasticsearch_hosts }}"
  become: true

- name: Clean up temporary PKCS12 files
  ansible.builtin.file:
    path: "/tmp/{{ item }}.p12"
    state: absent
  loop: "{{ elasticsearch_hosts }}"
  become: true

- name: Create certbot post renewal hook
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      DOMAIN=$1

      # Create PKCS12 file
      openssl pkcs12 -export \
        -in /etc/letsencrypt/live/$DOMAIN/fullchain.pem \
        -inkey /etc/letsencrypt/live/$DOMAIN/privkey.pem \
        -out /tmp/$DOMAIN.p12 \
        -name elasticsearch -passout pass:{{ elasticsearch_cert_password }}

      # Copy the PKCS12 file to Elasticsearch certs directory
      cp /tmp/$DOMAIN.p12 {{ elasticsearch_certs_dir }}/$DOMAIN.p12

      # Cleanup
      rm -f /tmp/$DOMAIN.p12

      # Restart Elasticsearch service
      systemctl restart elasticsearch
    dest: "/etc/letsencrypt/renewal-hooks/post/elasticsearch-renewal.sh"
    mode: '0755'
  become: true

# Ensure certbot timer is active and running
- name: Ensure certbot timer is active and running
  ansible.builtin.systemd:
    name: certbot.timer
    state: started
    enabled: true
  become: true